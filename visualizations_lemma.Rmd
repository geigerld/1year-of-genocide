---
date: "2024-09-22"
output: html_document
---

loading libraries and defining colors:
```{r}
rm(list = ls())

library(tidyverse)
library(plotly)
library(patchwork)

# Color palette
media_colors <- c("#d69d10", "#000000", "#cc0000", "#05b2fc")
```


importing and cleaning data:
```{r}
# Updated function to process each data frame
process_frequency_data <- function(file_path, media_name) {
  df <- read_csv(file_path, show_col_types = FALSE)
  
  # Check the column names
  #print(colnames(df))
  
  df %>%
    mutate(publish_date = as.Date(as.character(publish_date), format = "%Y%m%d")) %>%
    pivot_longer(cols = starts_with(".."), names_to = "word_lemma", values_to = "count_lemma") %>%
    pivot_longer(cols = ends_with(".."), names_to = "word_token", values_to = "count_token") %>%  # Adjusted to use ends_with("..")
    mutate(
      word_lemma = str_remove(word_lemma, "^\\.\\."),  # Remove the ".." prefix
      word_token = str_remove(word_token, "\\.\\.$")   # Remove the ".." suffix
    ) %>%
    group_by(word_lemma) %>%
    arrange(publish_date, .by_group = TRUE) %>%
    mutate(count_lemma_acum = cumsum(count_lemma)) %>%
    mutate(count_lemma_max = max(count_lemma_acum)) %>%
    mutate(slope = (count_lemma_acum - lag(count_lemma_acum)) / as.numeric(publish_date - lag(publish_date)))%>%
    ungroup() %>%
    mutate(log_count_lemma_acum = log(count_lemma_acum + 1)) %>%
    mutate(media = media_name)
}

# Apply the function with the updated folder path
AJ <- process_frequency_data("frequency_data_new/en_AJ_frequency.csv", "AJ")
BBC <- process_frequency_data("frequency_data_new/en_BBCNews_frequency.csv", "BBC")
CNN <- process_frequency_data("frequency_data_new/en_CNN_frequency.csv", "CNN")
DW <- process_frequency_data("frequency_data_new/en_DW_frequency.csv", "DW")
```
## filter data
We only want the data after the 7th October
```{r}
AJ <- AJ %>% filter(publish_date > "2023-08-07")
BBC <- BBC %>% filter(publish_date > "2023-08-07")
CNN <- CNN %>% filter(publish_date > "2023-08-07")
DW <- DW %>% filter(publish_date > "2023-08-07")

```

```{r}
AJ <- AJ %>% filter(total_word_count > 20)
BBC <- BBC %>% filter(total_word_count > 20)
CNN <- CNN %>% filter(total_word_count > 20)
DW <- DW %>% filter(total_word_count > 20)

```

## combine data
```{r}
combined_channels <- rbind(AJ, BBC, CNN, DW)
```


##creating function for plotting:
I changed the frequency to IPM:
(count_lemma / total_word_count) * 1e6) to account for differing video length
```{r}
plot_lemma <- function(lemma, date_to_plot) {
  # Plotting
  filtered_data <- combined_channels %>%
    filter(word_lemma == lemma) %>%
    filter(as.Date(publish_date, format = "%Y-%m-%d") > as.Date("2023-10-07"))
  
  plot1 <- filtered_data %>%
    ggplot(aes(x = publish_date, y = count_lemma_acum/count_lemma_max, color = media)) +
    geom_line() +
    theme_minimal() +
    theme(panel.grid = element_blank(),
          axis.text.x = element_blank()) +
    #scale_y_log10() +
    scale_color_manual(values = media_colors) +
    xlab("") +
    ylab("Relative accumulated frequency") +
    geom_vline(xintercept = as.Date(date_to_plot), linetype = "dashed") +
    labs(title = paste0("Mentions of ", lemma," in media"))

  plot2 <- filtered_data %>%
    ggplot(aes(x = publish_date, y = ((count_lemma / total_word_count) * 1e6), fill = media)) +
    geom_vline(xintercept = as.Date(date_to_plot), linetype = "dashed") +
    geom_col(alpha = 0.7) +
    theme_minimal() +
    theme(panel.grid = element_blank()) +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(values = media_colors) +
    xlab("") +
    ylab("IPM")

  # Align the plots by a common X axis
  aligned_plots <- plot1 / plot2

  # Display the aligned plots
  print(aligned_plots)
}

```

plotting lemmas
```{r}
plot_lemma(lemma = "Palestine", 
           date_to_plot = c("2024-04-25", "2024-06-07"))

plot_lemma(lemma = "Israel", 
           date_to_plot = c("2024-04-25", "2024-06-07"))
```
```{r}
  filtered_data <- combined_channels %>%
    filter(word_lemma == "Israel")
 filtered_data   <- filtered_data %>%
   mutate(rel.Freq = ((count_lemma / total_word_count) * 1e6) )
   
   
plot1 <- ggplot(filtered_data, aes(x = publish_date, y = ((count_lemma / total_word_count) * 1e6), fill=media)) +
  #geom_line(size = 1)+
  labs(
    title = "Mentions of Palestine in the media",
    x = "Publish Date",
    y = "Relative Frequency log10(IPM)",
    color = "Word Lemma"
  ) +
 geom_col(alpha = 0.7, position = "stack") +
  #geom_point()+
    theme_minimal() +
    theme(panel.grid = element_blank()) +
    scale_fill_manual(values = media_colors) 

ggplotly(plot1)
```

```{r}

  filtered_data <- combined_channels %>%
    filter(word_lemma == "genocide")
           
ggplot(filtered_data, aes(x = publish_date, y = slope, color=media)) +
  geom_smooth(size = 1) +
  #geom_line(size = 1)+
  labs(
    title = expression(paste("Slope of Cumulative Frequency of ",italic("Genocide")," Over Time")),
    x = "Publish Date",
    y = "Slope (Rate of Change)",
    color = "Word Lemma"
  ) +
    theme_minimal() +
    theme(panel.grid = element_blank()) +
    scale_color_manual(values = media_colors)
```





